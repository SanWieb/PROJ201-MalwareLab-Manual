<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="S.J. Wiebing">
<title>Installation Manual NIDS &amp; HIDS Malware lab</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Installation Manual NIDS &amp; HIDS Malware lab</h1>
<div class="details">
<span id="author" class="author">S.J. Wiebing</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_preface">1. Preface</a></li>
<li><a href="#_installation_configuration">2. Installation &amp; Configuration</a>
<ul class="sectlevel2">
<li><a href="#_vmware_workstation_pro">2.1. VMware Workstation Pro</a>
<ul class="sectlevel3">
<li><a href="#_installation">2.1.1. Installation</a></li>
<li><a href="#_virtual_networks">2.1.2. Virtual Networks</a></li>
</ul>
</li>
<li><a href="#_pfsense">2.2. pfSense</a>
<ul class="sectlevel3">
<li><a href="#_installation_pfsense">2.2.1. Installation pfSense</a></li>
<li><a href="#_adapter_settings_host_machine">2.2.2. Adapter Settings host machine</a></li>
<li><a href="#_setup_pfsense">2.2.3. Setup pfSense</a>
<ul class="sectlevel4">
<li><a href="#_network_configuration_pfsense">Network Configuration PfSense</a></li>
<li><a href="#_pfsense_web_configurator_setup">pfSense Web configurator setup</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_victim_machine_windows_10">2.3. Victim Machine (Windows 10)</a>
<ul class="sectlevel3">
<li><a href="#_installation_victim">2.3.1. Installation Victim</a></li>
<li><a href="#_vmwarehardenedloader">2.3.2. VmwareHardenedLoader</a>
<ul class="sectlevel4">
<li><a href="#_edit_vmx_file">Edit .vmx file</a></li>
</ul>
</li>
<li><a href="#_install_vmloader">2.3.3. Install VMloader</a></li>
<li><a href="#_additional_software">2.3.4. Additional software</a></li>
<li><a href="#_openssh_server">2.3.5. OpenSSH Server</a></li>
<li><a href="#_wazuh_agent">2.3.6. Wazuh agent</a></li>
<li><a href="#_disable_windows_defender">2.3.7. Disable Windows Defender</a></li>
</ul>
</li>
<li><a href="#_nids">2.4. NIDS</a>
<ul class="sectlevel3">
<li><a href="#_installation_ubuntu_server_18">2.4.1. Installation Ubuntu Server 18</a></li>
<li><a href="#_snort_2_9">2.4.2. Snort 2.9</a>
<ul class="sectlevel4">
<li><a href="#_installation_2">Installation</a></li>
<li><a href="#_download_rules">Download rules</a></li>
<li><a href="#_edit_snort_configuration_file">Edit Snort configuration file</a></li>
<li><a href="#_configuring_network_cards">Configuring Network Cards</a></li>
<li><a href="#_run_a_test">Run a test</a></li>
</ul>
</li>
<li><a href="#_suricata_5_0">2.4.3. Suricata 5.0</a>
<ul class="sectlevel4">
<li><a href="#_installation_3">Installation</a></li>
<li><a href="#_download_rules_2">Download rules</a></li>
<li><a href="#_edit_suricata_configuration_file">Edit Suricata configuration file</a></li>
<li><a href="#_run_a_test_2">Run a test</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_hids">2.5. HIDS</a>
<ul class="sectlevel3">
<li><a href="#_installation_ubuntu_server_18_2">2.5.1. Installation Ubuntu Server 18</a></li>
<li><a href="#_docker_io">2.5.2. Docker.io</a></li>
<li><a href="#_wazuh_container">2.5.3. Wazuh Container</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_last_configuration">3. Last configuration</a>
<ul class="sectlevel2">
<li><a href="#_pfsense_firewall_rules">3.1. pfSense Firewall rules</a>
<ul class="sectlevel3">
<li><a href="#_wan_interface">3.1.1. WAN interface</a></li>
<li><a href="#_lan_interface">3.1.2. LAN interface</a></li>
<li><a href="#_opt1_interface">3.1.3. OPT1 interface</a></li>
</ul>
</li>
<li><a href="#_register_wazuh_agent_at_wazuh_manager">3.2. Register Wazuh agent at Wazuh manager</a></li>
<li><a href="#_install_filebeat_on_nids">3.3. Install Filebeat on NIDS</a></li>
<li><a href="#_wazuh">3.4. Wazuh</a>
<ul class="sectlevel3">
<li><a href="#_configure_wazuh_group_configuration">3.4.1. Configure Wazuh Group configuration</a></li>
<li><a href="#_sysmon_second_batch">3.4.2. Sysmon Second Batch</a></li>
<li><a href="#_sysmon_third_batch">3.4.3. Sysmon Third Batch</a></li>
</ul>
</li>
<li><a href="#_tor_vpn_tunneling">3.5. Tor / VPN Tunneling</a></li>
</ul>
</li>
<li><a href="#_cuckoo_sandbox">4. Cuckoo Sandbox</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_preface">1. Preface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document is a manual for installing a Malware Lab environment. The Malware lab is intended for a research project to compare the detection difference between a NIDS and HIDS.
The aim of the research was to advise small and medium-sized enterprises if network detection (NIDS) sufficient is
to detect malware infection in a enterprise network or that End-Point detection (HIDS) is necessary.
The results of the research can be found <a href="https://github.com/SanWieb/MalwareResults">here</a>.</p>
</div>
<div class="paragraph">
<p>The manual is subdivided in to the following parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Installation &amp; Configuration of:</p>
<div class="ulist">
<ul>
<li>
<p>VMware Workstation Pro</p>
</li>
<li>
<p>PFSense</p>
</li>
<li>
<p>Windows 10 VM (Victim Machine)</p>
</li>
<li>
<p>HIDS (Ubuntu Server 18 with Wazuh)</p>
</li>
<li>
<p>NIDS (Ubuntu Server 18 with Snort &amp; Suricata)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Last configuration to combine these VM&#8217;s</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The design of the malware lab:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/setup.png" alt="Malware Lab Infrastructure" width="600">
</div>
<div class="title">Figure 1. Malware Lab Infrastructure</div>
</div>
<div class="paragraph">
<p>Wazuh is during the research enriched with <a href="https://github.com/Neo23x0/sigma">Sigma</a> rules, the converted Wazuh rules can be found in the
<a href="https://github.com/SanWieb/sigWah">sigWah</a> repository.</p>
</div>
<hr>
<div class="paragraph">
<p><a href="https://github.com/SanWieb/PROJ201-MalwareLab-Manual/raw/master/PROJ201_MalwareLab_Manual.pdf">Click here for the PDF Version of the manual</a></p>
</div>
<div class="paragraph">
<p><a href="https://sanwieb.github.io/PROJ201-MalwareLab-Manual">Click here for the HTML Version of the manual:</a></p>
</div>
<div class="paragraph">
<p>Author: Sander Wiebing</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_configuration">2. Installation &amp; Configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_vmware_workstation_pro">2.1. VMware Workstation Pro</h3>
<div class="paragraph">
<p>In this manual we will use VMware Workstation Pro as the virtualization software.
The Pro version is not free but a trial of 30 days is available.</p>
</div>
<div class="sect3">
<h4 id="_installation">2.1.1. Installation</h4>
<div class="paragraph">
<p>Download the latest version <a href="https://my.vmware.com/en/web/vmware/info/slug/desktop_end_user_computing/vmware_workstation_pro/15_0">here</a>, we are using version 15.5.2.
Run the installer and complete the installation, no additional settings are
required during the installation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_virtual_networks">2.1.2. Virtual Networks</h4>
<div class="paragraph">
<p>The Malware Lab uses 4 virtual networks. By default VMware has 3 virtual networks:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>VMnet0 - Birdged network</p>
</li>
<li>
<p>VMnet1 - Host only network</p>
</li>
<li>
<p>VMnet8 - NAT adapter</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Open VMware Workstation Pro and go to <em>Edit &gt; Virtual Network Editor</em>, the default networks
should be visible.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Click in Windows on 'Change Settings' to make the VMnet0 network and settings options available.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Follow the steps below to setup the virtual networks:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Select VMnet1</p>
<div class="ulist">
<ul>
<li>
<p>Uncheck 'Use local DHCP service to distribute IP address to VM'</p>
</li>
<li>
<p>Press 'Add Network' &gt; VMnet2 &gt; Ok</p>
</li>
</ul>
</div>
</li>
<li>
<p>Select VMnet2</p>
<div class="ulist">
<ul>
<li>
<p>Uncheck connect a host virtual adapter to this network</p>
</li>
<li>
<p>Uncheck 'Use local DHCP service to distribute IP address to VM'</p>
</li>
</ul>
</div>
</li>
<li>
<p>Press 'Add Network' &gt; VMnet 3 &gt; Ok</p>
<div class="ulist">
<ul>
<li>
<p>Uncheck connect a host virtual adapter to this network</p>
</li>
<li>
<p>Uncheck 'Use local DHCP service to distribute IP address to VM'</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>After the setup the Virtual Network Editor should look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/virtual_networks_preferences.png" alt="Virtual Network Editor">
</div>
<div class="title">Figure 2. Virtual Network Editor</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_pfsense">2.2. pfSense</h3>
<div class="paragraph">
<p>pfSense will be used as the Firewall in the malware lab environment. The latest
ISO file can be downloaded <a href="https://www.pfsense.org/download/">here</a>, select the AMD64
architecture and select the installer 'CM image (ISO) installer'. In this manual version
2.4.4-p3 will be used.</p>
</div>
<div class="sect3">
<h4 id="_installation_pfsense">2.2.1. Installation pfSense</h4>
<div class="paragraph">
<p>After the download is completed unzip the file and follow the steps below:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In VMware Workstation Pro click on File &gt; New Virtual Machine</p>
</li>
<li>
<p>Select Typical &gt; Next</p>
</li>
<li>
<p>Browse to the just downloaded pfSense ISO &gt; Next</p>
</li>
<li>
<p>Give the VM a name, enter 'pfSense' &gt; Next</p>
</li>
<li>
<p>Set the maximum disk size to 5 GB</p>
</li>
<li>
<p>Select 'Store virtual disk size as a single file' &gt; next</p>
</li>
<li>
<p>Click 'Customize hardware'</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Set the amount of memory to 512 MB</p>
</li>
<li>
<p>Click on 'Network Adapter'</p>
<div class="ulist">
<ul>
<li>
<p>Select 'Connect at power on'</p>
</li>
<li>
<p>Select 'Bridged: Connected to  the physical network'</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click 'Add&#8230;&#8203;'</p>
<div class="ulist">
<ul>
<li>
<p>Select 'Network Adapter' &gt; Next</p>
</li>
<li>
<p>Select Custom &gt; VMnet1 (Host-only)</p>
</li>
<li>
<p>Check 'Connect at power on'</p>
</li>
<li>
<p>Press finish</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click 'Add&#8230;&#8203;'</p>
<div class="ulist">
<ul>
<li>
<p>Select 'Network Adapter' &gt; Next</p>
</li>
<li>
<p>Select Custom &gt; VMnet2</p>
</li>
<li>
<p>Check 'Connect at power on'</p>
</li>
<li>
<p>Press finish</p>
</li>
</ul>
</div>
</li>
<li>
<p>Select 'USB controller' &gt; Click 'Remove'</p>
</li>
<li>
<p>Select 'Sound Card' &gt; Click 'Remove'<br>
The hardware configuration should look like this:<br></p>
<div class="imageblock">
<div class="content">
<img src="images/hardware_configuration_pfSense.png" alt="Hardware Configuration pfSense">
</div>
<div class="title">Figure 3. Hardware Configuration pfSense</div>
</div>
</li>
<li>
<p>Click 'Close'</p>
</li>
</ol>
</div>
</li>
<li>
<p>Click 'Finish'</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_adapter_settings_host_machine">2.2.2. Adapter Settings host machine</h4>
<div class="paragraph">
<p>On the Windows machine are some Network adapter settings required, follow the steps
below:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open Network and Sharing Center (Control Panel\Network and Internet\Network and Sharing Center)</p>
</li>
<li>
<p>Click 'Change adapter Settings'</p>
</li>
<li>
<p>Right click 'VMware Network Adapter VMnet1' &gt; select Properties</p>
</li>
<li>
<p>Disable all options except of:</p>
<div class="ulist">
<ul>
<li>
<p>QoS Packet Scheduler</p>
</li>
<li>
<p>Internet Protocol Version 4 (TCP/IPv4)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Select 'Internet Protocol Version 4 (TCP/IPv4)' and click 'Properties'</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Fill in the following properties:</p>
<div class="ulist">
<ul>
<li>
<p>IP address: <strong>172.16.1.2</strong></p>
</li>
<li>
<p>Subnet mask: <strong>255.255.255.0</strong></p>
</li>
<li>
<p>Default gateway: <strong>&lt;empty&gt;</strong></p>
</li>
</ul>
</div>
</li>
<li>
<p>The properties should look like this:</p>
<div class="imageblock">
<div class="content">
<img src="images/windows_adaptersettings.png" alt="Windows Adapter Settings VMnet1" width="300">
</div>
<div class="title">Figure 4. Windows Adapter Settings VMnet1</div>
</div>
</li>
<li>
<p>Click 'Advanced' &gt; select the 'WINS' tab</p>
<div class="ulist">
<ul>
<li>
<p>Disable 'NetBIOS over TCP/IP':</p>
<div class="imageblock">
<div class="content">
<img src="images/windows_adaptersettings_advancedwins.png" alt="Windows Advanced Adapter Settings VMnet1" width="300">
</div>
<div class="title">Figure 5. Windows Advanced Adapter Settings VMnet1</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>To finish, click 3 times 'OK'</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_setup_pfsense">2.2.3. Setup pfSense</h4>
<div class="paragraph">
<p>After the installation pfSense the pfSense VM is ready to start and to configurate.
Follow the steps below:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Select in VMware Workstaion Pro the pfSene vm and press 'Start up this guest operating
system'</p>
</li>
<li>
<p>Read the Copyright and distribution notice and select Accept &gt; press enter</p>
</li>
<li>
<p>Select 'Install pfSense ' &gt; press enter</p>
</li>
<li>
<p>Select the right keymap &gt; press enter</p>
</li>
<li>
<p>Select 'Guided disk setup' &gt; press enter</p>
</li>
<li>
<p>After the install is completed, select 'No' for the manual configuration option &gt; press enter</p>
</li>
<li>
<p>Select reboot &gt; press Enter</p>
</li>
<li>
<p>After the reboot, power off the machine</p>
</li>
<li>
<p>Select pfSense VM &gt; right click &gt; 'Settings'</p>
</li>
<li>
<p>Select CD/DVD (IDE) &gt; Click 'Remove'</p>
</li>
<li>
<p>Select Network adapter &gt; Press advanced</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Document the MAC-address</p>
</li>
<li>
<p>Repeat this step for Network adapter 2 and 3<br>
Mac-addresses in our case:</p>
<div class="ulist">
<ul>
<li>
<p>Network Adapter (VMnet0): 00:0C:29:2E:BC:73</p>
</li>
<li>
<p>Network Adapter 2 (VMnet1): 00:0C:29:2E:BC:7D</p>
</li>
<li>
<p>Network Adapter 3 (VMnet2): 00:0C:29:2E:BC:87</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_network_configuration_pfsense">Network Configuration PfSense</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start the pfSense VM</p>
</li>
<li>
<p>Select option 1, 'Assign Interfaces'</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Enter 'n' for the question 'Should VLANs be set up now?'</p>
</li>
<li>
<p>Check using the documented MAC-address which adapter is which VMnet</p>
</li>
<li>
<p>Assign the WAN interface to the Network Adapter (VMnet0), in our case em0</p>
</li>
<li>
<p>Assign the LAN interface to the Network Adapter 2 (VMnet1), in our case em1</p>
</li>
<li>
<p>Assign the Optional 1 interface to the Network Adapter 3 (VMnet2), in our case em2</p>
</li>
<li>
<p>Enter 'y'</p>
</li>
</ol>
</div>
</li>
<li>
<p>Select option 2, 'Set interface(s) IP address'</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Enter 1 (WAN)</p>
</li>
<li>
<p>Fil out the following settings:</p>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>LAN IP: <strong>172.16.1.1</strong><br>
LAN Subnet bit count: <strong>24</strong><br>
LAN upstream gateway address: <strong>&lt;empty&gt;</strong><br>
LAN IPv6 address: <strong>&lt;empty&gt;</strong><br>
Do you want to enable the DHCP server on LAN? <strong>y</strong><br>
LAN DHCP start address: <strong>172.16.1.10</strong><br>
LAN DHCP end address: <strong>172.16.1.254</strong><br>
Do you want to revert to HTTP as the webConfigurator protocol? <strong>n</strong></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Select again option 2, 'Set interface(s) IP address'</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Enter 2 (LAN)</p>
</li>
<li>
<p>Fil out the following settings:</p>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>LAN IP: <strong>172.16.1.1</strong><br>
LAN Subnet bit count: <strong>24</strong><br>
LAN upstream gateway address: <strong>&lt;empty&gt;</strong><br>
LAN IPv6 address: <strong>&lt;empty&gt;</strong><br>
Do you want to enable the DHCP server on LAN? <strong>y</strong><br>
LAN DHCP start address: <strong>172.16.1.10</strong><br>
LAN DHCP end address: <strong>172.16.1.254</strong><br>
Do you want to revert to HTTP as the webConfigurator protocol? <strong>n</strong></p>
</div>
</div>
</div>
</li>
<li>
<p>Press enter</p>
</li>
</ol>
</div>
</li>
<li>
<p>Select for the last time option 2, 'Set interface(s) IP address</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Enter 3 (OPT1)</p>
</li>
<li>
<p>Fil out the following settings:</p>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>LAN IP: <strong>172.16.2.1</strong><br>
LAN Subnet bit count: <strong>24</strong><br>
LAN upstream gateway address: <strong>&lt;empty&gt;</strong><br>
LAN IPv6 address: <strong>&lt;empty&gt;</strong><br>
Do you want to enable the DHCP server on LAN? <strong>y</strong><br>
LAN DHCP start address: <strong>172.16.2.10</strong><br>
LAN DHCP end address: <strong>172.16.2.254</strong><br>
Do you want to revert to HTTP as the webConfigurator protocol? <strong>n</strong></p>
</div>
</div>
</div>
</li>
<li>
<p>Press enter</p>
</li>
</ol>
</div>
</li>
<li>
<p>The pfSense Menu should look something like this:</p>
<div class="imageblock">
<div class="content">
<img src="images/pfsense_menu.png" alt="pfSense Menu">
</div>
<div class="title">Figure 6. pfSense Menu</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Don&#8217;t forget to take several snapshots in the installation process.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_pfsense_web_configurator_setup">pfSense Web configurator setup</h5>
<div class="paragraph">
<p>Open on the host machine a web browser and navigate to <a href="https://172.16.1.1" class="bare">https://172.16.1.1</a> (the LAN
interface). Log in with the default credentials <strong>admin/pfsense</strong> and follow the steps below:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the 'pfSense Setup' click 2 times 'next'</p>
</li>
<li>
<p>Fill out the following settings:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Primary DNS Server <strong>8.8.8.8</strong></p>
</li>
<li>
<p>Secondary DNS server <strong>8.8.4.4</strong></p>
</li>
</ol>
</div>
</li>
<li>
<p>Click 'next'</p>
</li>
<li>
<p>Uncheck the following options:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Block private networks from entering via WAN</p>
</li>
<li>
<p>Block non-Internet routed networks from entering via WAN</p>
</li>
</ol>
</div>
</li>
<li>
<p>Click 'next'</p>
</li>
<li>
<p>Set a admin password</p>
</li>
<li>
<p>Finish the setup</p>
</li>
<li>
<p>On the top bar, go to Firewall &gt; rules</p>
</li>
<li>
<p>Select 'LAN' and click the 'add' button <u>with the arrow facing up</u></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Fill out the follow settings:</p>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Action: <strong>Pass</strong><br>
Disabled: <strong>&lt;unchecked&gt;</strong><br>
Interface: <strong>LAN</strong><br>
Address Family: <strong>IPv4</strong><br>
Protocol: <strong>TCP</strong><br>
Source: <strong>&lt;uncheck invert match&gt;</strong> - <strong>Single host or alias</strong> - <strong>172.16.1.2</strong><br>
Destination: <strong>&lt;uncheck invert match&gt;</strong> - <strong>Single host or alias</strong> - <strong>172.16.1.1</strong><br>
Destination port range: From <strong>HTTPS(443)</strong> - To <strong>HTTPS(443)</strong><br>
Log: <strong>&lt;uncheck&gt;</strong><br>
Description: <strong>pfsense strict anti-lockout</strong></p>
</div>
</div>
</div>
</li>
<li>
<p>Click 'save'</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This rule will prevent the machine from accessing the pfSense Web Interface
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Select 'OP1' and click the 'add' button <u>with the arrow facing up</u></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Fill out the follow settings:</p>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Action: <strong>Pass</strong><br>
Disabled: <strong>&lt;unchecked&gt;</strong><br>
Interface: <strong>OP1</strong><br>
Address Family: <strong>IPv4</strong><br>
Protocol: <strong>Any</strong><br>
Source: <strong>&lt;uncheck invert match&gt;</strong> - <strong>OPT1 net</strong><br>
Destination: <strong>&lt;uncheck invert match&gt;</strong> - <strong>Any</strong><br>
Log: <strong>&lt;uncheck&gt;</strong><br>
Description: <strong>Default allow OPT1 to any rule</strong></p>
</div>
</div>
</div>
</li>
<li>
<p>Click 'save'</p>
</li>
</ol>
</div>
</li>
<li>
<p>Still in 'OP1', click again the 'add' button <u>with the arrow facing up</u></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Fill out the follow settings:</p>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Action: <strong>Pass</strong><br>
Disabled: <strong>&lt;unchecked&gt;</strong><br>
Interface: <strong>OP1</strong><br>
Address Family: <strong>IPv6</strong><br>
Protocol: <strong>Any</strong><br>
Source: <strong>&lt;uncheck invert match&gt;</strong> - <strong>OPT1 net</strong><br>
Destination: <strong>&lt;uncheck invert match&gt;</strong> - <strong>Any</strong><br>
Log: <strong>&lt;uncheck&gt;</strong><br>
Description: <strong>Default allow OPT1 to any rule</strong></p>
</div>
</div>
</div>
</li>
<li>
<p>Click 'save'</p>
</li>
</ol>
</div>
</li>
<li>
<p>Click 'Apply Changes'</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
These two rules will give OPT1 internet access
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Navigate to Firewall &gt; Aliases</p>
</li>
<li>
<p>Select 'IP' and click on 'Add'</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Fill out the follow settings in 'Properties':</p>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Name: <strong>RFC1918</strong><br>
Description: <strong>An alias for all RFC1918 netowrks</strong><br>
Type: <strong>Network(s)</strong><br></p>
</div>
</div>
</div>
</li>
<li>
<p>Press 2 times on 'Add network' and set the network settings to:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Address: <strong>10.0.0.0/8</strong> Description: <strong>10.x.x.x RFC 1918 networks</strong></p>
</li>
<li>
<p>Address: <strong>172.16.0.0/12</strong> Description: <strong>172.16.x.x RFC 1918 networks</strong></p>
</li>
<li>
<p>Address: <strong>192.168.0.0/16</strong> Description: <strong>192.168.x.x RFC 1918 networks</strong></p>
</li>
</ol>
</div>
</li>
<li>
<p>Click 'Save'</p>
</li>
</ol>
</div>
</li>
<li>
<p>Click 'Apply Changes'</p>
</li>
<li>
<p>Navigate to System &gt; Advanced</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Enable the option 'Disable webConfigurator anti-lockout rule'</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Without the firewall rule above you will block your self from access the WebConfigurator
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_victim_machine_windows_10">2.3. Victim Machine (Windows 10)</h3>
<div class="paragraph">
<p>The victim machine will have Windows 10 as operating system. Free to download virtual machines
are available on <a href="https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/">this</a> site,
they are completely ready but the VMware Tools are
installed by default. VMware tools can be easily detect by malware, that is why we
will use a Windows 10 ISO. With the Media Creation Tool it is possible to make a ISO file, the tool
can be downloaded <a href="https://www.microsoft.com/nl-nl/software-download/windows10">here</a>.</p>
</div>
<div class="sect3">
<h4 id="_installation_victim">2.3.1. Installation Victim</h4>
<div class="paragraph">
<p>After the Windows 10 ISO file is ready, follow the steps below:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In VMware Workstation Pro click on File &gt; New Virtual Machine</p>
</li>
<li>
<p>Select Typical &gt; Next</p>
</li>
<li>
<p>Browse to the created Windows 10 ISO &gt; Next</p>
</li>
<li>
<p>Give the VM a name, enter 'Victim_Windows10' &gt; Next</p>
</li>
<li>
<p>Set the maximum disk size to 100 GB</p>
</li>
<li>
<p>Select 'Store virtual disk size as a single file' &gt; next</p>
</li>
<li>
<p>Click 'Customize hardware'</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Set the amount of memory to 2048 MB</p>
</li>
<li>
<p>Set number of processors to 2</p>
</li>
<li>
<p>Set number of cores per processor to 2</p>
</li>
<li>
<p>Set the MAC-address to: "E4-70-B8-23-CF-E0"</p>
</li>
<li>
<p>Click on 'Network Adapter'</p>
<div class="ulist">
<ul>
<li>
<p>Select 'Connect at power on'</p>
</li>
<li>
<p>Select Custom &gt; VMnet2</p>
</li>
</ul>
</div>
</li>
<li>
<p>Press Close</p>
</li>
</ol>
</div>
</li>
<li>
<p>Press Finish</p>
</li>
<li>
<p>Log in to the pfSense web UI</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to Services &gt; DHCP server and select 'OPT1'</p>
</li>
<li>
<p>Add a Static mapping</p>
<div class="ulist">
<ul>
<li>
<p>Mac-adress of the victim machine: E4-70-B8-23-CF-E0</p>
</li>
<li>
<p>IP Address: 172.16.2.2</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click 'save' &gt; 'Apply changes'</p>
</li>
</ol>
</div>
</li>
<li>
<p>Start the Virtual Machine<br></p>
</li>
<li>
<p>Go through the installation process</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Select 'I  don&#8217;t have a product key'</p>
</li>
<li>
<p>Select Windows 10 Home</p>
</li>
<li>
<p>Select option 'Custom: Install Windows Only'</p>
</li>
<li>
<p>Select the unallocated Space &gt; next<br>
Windows will be installed</p>
</li>
</ol>
</div>
</li>
<li>
<p>When is asked to sign in, follow these steps:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Fill in for username: test</p>
</li>
<li>
<p>Password: test (or something else)<br>
You will get a error that the account is locked, now you can use a offline account</p>
</li>
</ol>
</div>
</li>
<li>
<p>Resume the installation</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Enter the name: 'John Williams'</p>
</li>
<li>
<p>Fill in a password and <strong>document it</strong></p>
</li>
<li>
<p>Fill in the security questions</p>
</li>
</ol>
</div>
</li>
<li>
<p>Disable all features and extra services like 'find my device'<br>
Windows will be loaded, remember:</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Do not install VMware Tools!
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_vmwarehardenedloader">2.3.2. VmwareHardenedLoader</h4>
<div class="paragraph">
<p>With the standard configuration, the virtual environment is easily detected by malware.
A example below, a simple PowerShell command reveals the virtualization
with the manufacturer and model field.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/vmware_wmi.png" alt="PowerShell Win32_ComputerSystem">
</div>
<div class="title">Figure 7. PowerShell Win32_ComputerSystem</div>
</div>
<div class="paragraph">
<p>VmwareHardenedLoader is an open-source tool on github. It is a
detection mitigation loader, it gets vmware guest undetected by VMProtect 3.2,
Safengine and Themida (anti-vm feature).</p>
</div>
<div class="paragraph">
<p>We will follow the steps provided <a href="https://github.com/hzqst/VmwareHardenedLoader#installation">here</a>,
the first part is editing the .vmx file.</p>
</div>
<div class="sect4">
<h5 id="_edit_vmx_file">Edit .vmx file</h5>
<div class="paragraph">
<p>Shut down (Do not pause) the Victim machine, in Workstation, right click on
'Victim_Windows10' &gt; 'Open VM Directory'. Open the .vmx file (Victim_Windows10.vmx)
in a text editor and add the following settings (at the bottom):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>hypervisor.cpuid.v0 = "FALSE"
board-id.reflectHost = "TRUE"
hw.model.reflectHost = "TRUE"
serialNumber.reflectHost = "TRUE"
smbios.reflectHost = "TRUE"
SMBIOS.noOEMStrings = "TRUE"
isolation.tools.getPtrLocation.disable = "TRUE"
isolation.tools.setPtrLocation.disable = "TRUE"
isolation.tools.setVersion.disable = "TRUE"
isolation.tools.getVersion.disable = "TRUE"
monitor_control.disable_directexec = "TRUE"
monitor_control.disable_chksimd = "TRUE"
monitor_control.disable_ntreloc = "TRUE"
monitor_control.disable_selfmod = "TRUE"
monitor_control.disable_reloc = "TRUE"
monitor_control.disable_btinout = "TRUE"
monitor_control.disable_btmemspace = "TRUE"
monitor_control.disable_btpriv = "TRUE"
monitor_control.disable_btseg = "TRUE"
monitor_control.restrict_backdoor = "TRUE"
scsi0:0.productID = "Tencent SSD"
scsi0:0.vendorID = "Tencent"
ethernet0.address = "E4-70-B8-23-CF-E0"</pre>
</div>
</div>
<div class="paragraph">
<p>Save the file an start up the Victim machine. If we run the PowerShell command
again it will give as result something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/vmware_wmi_hardening.png" alt="PowerShell Win32_ComputerSystem with loader configuration">
</div>
<div class="title">Figure 8. PowerShell Win32_ComputerSystem with loader configuration</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_install_vmloader">2.3.3. Install VMloader</h4>
<div class="paragraph">
<p>Step 2 is installing the VmwareHardenedLoader service. Download the 'bin' folder
<a href="https://github.com/hzqst/VmwareHardenedLoader/tree/master/bin">here</a> and run
install.bat as administrator in the victim machine.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/vmwarehardenedloader_install.png" alt="VMwareHardenedLoader install">
</div>
<div class="title">Figure 9. VMwareHardenedLoader install</div>
</div>
</div>
<div class="sect3">
<h4 id="_additional_software">2.3.4. Additional software</h4>
<div class="paragraph">
<p>We will install some extra software for two reasons. First the machine
has to look as a normal machine which is being used, second it helps some
malware to run as they might have it as a dependency.</p>
</div>
<div class="paragraph">
<p>The following software has to be installed:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Installed software</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Version</th>
<th class="tableblock halign-left valign-top">link</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Google Chrome</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">80.0.3987.132</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.google.com/chrome" class="bare">https://www.google.com/chrome</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Firefox</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">74.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.mozilla.org/firefox/new/" class="bare">https://www.mozilla.org/firefox/new/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x65 Java runtime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8 Update 241</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.java.com/download" class="bare">https://www.java.com/download</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Core Runtime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">v3.1.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://dotnet.microsoft.com/download/dotnet-core" class="bare">https://dotnet.microsoft.com/download/dotnet-core</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Silverlight</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://microsoft.com/silverlight" class="bare">https://microsoft.com/silverlight</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LibreOffice</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6.4.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://libreoffice.org/download/download" class="bare">https://libreoffice.org/download/download</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7-Zip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19.00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.7-zip.org/download.html" class="bare">https://www.7-zip.org/download.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Thunderbird</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">68.6.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.thunderbird.net" class="bare">https://www.thunderbird.net</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Python 3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.8.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.python.org/downloads" class="bare">https://www.python.org/downloads</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Python 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.7.17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.python.org/downloads" class="bare">https://www.python.org/downloads</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Microsoft Visual C++ Redistributable Package</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2015 - 2019 14.25.28508</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://support.microsoft.com/help/2977003/the-latest-supported-visual-c-downloads" class="bare">https://support.microsoft.com/help/2977003/the-latest-supported-visual-c-downloads</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nitro Reader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pro 11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.gonitro.com/pdf-reader" class="bare">https://www.gonitro.com/pdf-reader</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VLC media-player</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.0.8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://videolan.org" class="bare">https://videolan.org</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Microsoft Office Home and Student 2016</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://officecdn.microsoft.com/db/492350F6-3A01-4F97-B9C0-C7C6DDF67D60/media/en-US/HomeStudentRetail.img" class="bare">https://officecdn.microsoft.com/db/492350F6-3A01-4F97-B9C0-C7C6DDF67D60/media/en-US/HomeStudentRetail.img</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To resemble the victim machine as a normal machine we also create some folders
and documents. It does not matter what kind of documents, just fill it up.
Some sample documents:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>'Financial Sample.xlsx' - <a href="https://go.microsoft.com/fwlink/?LinkID=521962" class="bare">https://go.microsoft.com/fwlink/?LinkID=521962</a></p>
</li>
<li>
<p>Word templates - <a href="https://go.microsoft.com/fwlink/?LinkID=521962" class="bare">https://go.microsoft.com/fwlink/?LinkID=521962</a></p>
</li>
<li>
<p>Sample pdf - <a href="http://www.africau.edu/images/default/sample.pdf" class="bare">http://www.africau.edu/images/default/sample.pdf</a></p>
</li>
<li>
<p>Images - <a href="https://www.google.com/imghp" class="bare">https://www.google.com/imghp</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_openssh_server">2.3.5. OpenSSH Server</h4>
<div class="paragraph">
<p>To transfer the malicious files to the victim we will use the SCP command. For this
reason we are going to install the OpenSSH server</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open Powershell as Administrator</p>
</li>
<li>
<p>Run these commands:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0
Start-Service sshd
Set-Service -Name sshd -StartupType 'Automatic'</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_wazuh_agent">2.3.6. Wazuh agent</h4>
<div class="paragraph">
<p>We need to install the Wazuh agent to make monitoring for the HIDS possible.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start the Victim VM</p>
</li>
<li>
<p>Open a browser, go to the wazuh packages</p>
<div class="paragraph">
<p><a href="https://documentation.wazuh.com/3.11/installation-guide/packages-list/#windows" class="bare">https://documentation.wazuh.com/3.11/installation-guide/packages-list/#windows</a></p>
</div>
</li>
<li>
<p>Download the agent for windows (wazuh-agent-3.11.4-1.msi) and execute it</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Read and accept the term &gt; press 'Install'</p>
</li>
<li>
<p>Check 'Run agent configuration interface' and press 'Finish'</p>
</li>
<li>
<p>Set the Manager IP to: 172.16.1.3</p>
</li>
<li>
<p>CLick save and exit<br>
We register the agent to the manager when the installation of the HIDS is completed</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_disable_windows_defender">2.3.7. Disable Windows Defender</h4>
<div class="paragraph">
<p>We need to disable the Windows Defender to run the malware.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start the Victim VM</p>
</li>
<li>
<p>Press Windows Key + r</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Type in 'regedit' and click 'OK'</p>
</li>
</ol>
</div>
</li>
<li>
<p>Browse to the following path:</p>
<div class="listingblock">
<div class="content">
<pre>HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows Defender</pre>
</div>
</div>
</li>
<li>
<p>Right click on Windows defender folder</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Select New &gt; DWORD (32-bit)</p>
</li>
<li>
<p>Name it 'DisableAntiSpyware' and press Enter</p>
</li>
</ol>
</div>
</li>
<li>
<p>Double-click on the just created 'DisableAntiSpyware' item.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Set the value data to: 1</p>
<div class="imageblock">
<div class="content">
<img src="images/disable_windowsdefender.png" alt="Regex Editor - Disable Defender">
</div>
<div class="title">Figure 10. Regex Editor - Disable Defender</div>
</div>
</li>
<li>
<p>Restart the VM</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_nids">2.4. NIDS</h3>
<div class="paragraph">
<p>We will use Ubuntu Server as operating system for the NIDS and HIDS VM.
The ISO can be downloaded <a href="https://ubuntu.com/download/server">here</a> (18.04.4).</p>
</div>
<div class="sect3">
<h4 id="_installation_ubuntu_server_18">2.4.1. Installation Ubuntu Server 18</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In VMware Workstation Pro click on File &gt; New Virtual Machine</p>
</li>
<li>
<p>Select Typical &gt; Next</p>
</li>
<li>
<p>Browse to the downloaded Ubuntu Server ISO &gt; Next</p>
</li>
<li>
<p>Fill in the fields name, username (we use nids), password</p>
</li>
<li>
<p>Give the VM a name, enter 'NIDS' &gt; Next</p>
</li>
<li>
<p>Set the maximum disk size to 50 GB</p>
</li>
<li>
<p>Select 'Store virtual disk size as a single file' &gt; next</p>
</li>
<li>
<p>Click 'Customize hardware'</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Set the amount of memory to 2048 MB</p>
</li>
<li>
<p>Set number of processors to 2</p>
</li>
<li>
<p>Set number of cores per processor to 2</p>
</li>
<li>
<p>Click on 'Network Adapter'</p>
<div class="ulist">
<ul>
<li>
<p>Select 'Connect at power on'</p>
</li>
<li>
<p>Select Custom &gt; VMnet1 (Host-only)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click 'Add&#8230;&#8203;'</p>
<div class="ulist">
<ul>
<li>
<p>Select 'Network Adapter' &gt; Next</p>
</li>
<li>
<p>Select Custom &gt; VMnet2 (IPS1)</p>
</li>
<li>
<p><strong>Uncheck</strong> 'Connect at power on'</p>
</li>
<li>
<p>Press finish</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click 'Add&#8230;&#8203;'</p>
<div class="ulist">
<ul>
<li>
<p>Select 'Network Adapter' &gt; Next</p>
</li>
<li>
<p>Select Custom &gt; VMnet3 (IPS2)</p>
</li>
<li>
<p><strong>Uncheck</strong> 'Connect at power on'</p>
</li>
<li>
<p>Press finish</p>
</li>
</ul>
</div>
</li>
<li>
<p>Select 'USB controller' &gt; Click 'Remove'</p>
</li>
<li>
<p>Select 'Sound Card' &gt; Click 'Remove'</p>
</li>
<li>
<p>Select 'Printer' &gt; Click 'Remove'</p>
</li>
<li>
<p>Press Close</p>
</li>
</ol>
</div>
</li>
<li>
<p>Press Finish</p>
</li>
<li>
<p>Open the VM settings again</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Remove the CD/ DVD with the 'autoinst.iso' inserted</p>
</li>
<li>
<p>Remove the Floppy drive with the 'autoinst.flp' inserted</p>
</li>
</ol>
</div>
</li>
<li>
<p>Start the Virtual Machine<br></p>
</li>
<li>
<p>Go through the installation process</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>At the software selection phase, make sure to install OpenSSH server'</p>
</li>
</ol>
</div>
</li>
<li>
<p>Shut down the VM after the installation is completed</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Remove the last CD/DVD drive</p>
</li>
<li>
<p>Document the MAC-address of the network adapter</p>
</li>
<li>
<p>Check the <em>connect at power on</em> for Network adapter 2 (VMnet2) and
Network adapter 3 (VMnet3)</p>
</li>
</ol>
</div>
</li>
<li>
<p>Log in to the pfSense web UI</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to Services &gt; DHCP server and select 'LAN'</p>
</li>
<li>
<p>Add a Static mapping</p>
<div class="ulist">
<ul>
<li>
<p>Mac-adress of the NIDS machine (E4-70-B8-23-CF-E0)</p>
</li>
<li>
<p>IP Address: 172.16.1.4</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click 'save' &gt; 'Apply changes'</p>
</li>
</ol>
</div>
</li>
<li>
<p>Start up the VM</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Log in</p>
</li>
<li>
<p>Verify that the IP-adress is 172.16.1.4 (with ifconfig)</p>
</li>
<li>
<p>Update the vm with:</p>
<div class="listingblock">
<div class="content">
<pre>sudo apt-get update; sudo apt-get upgrade;</pre>
</div>
</div>
</li>
<li>
<p>Make sure the server has the correct time and time zone with:</p>
<div class="listingblock">
<div class="content">
<pre>sudo dpkg-reconfigure tzdata</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_snort_2_9">2.4.2. Snort 2.9</h4>
<div class="paragraph">
<p>The NIDS software we will install is Snort (<a href="http://www.snort.org/" class="bare">http://www.snort.org/</a>). For the
main we follow <a href="https://upcloud.com/community/tutorials/install-snort-ubuntu/">this</a> guide.
The steps are documented below</p>
</div>
<div class="sect4">
<h5 id="_installation_2">Installation</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log into the NIDS VM</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Login from the host machine with SHH to the NIDS VM for easy copy and paste
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Execute these commands:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Make a folder to store the downloaded files</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">mkdir ~/snort_src
cd ~/snort_src</code></pre>
</div>
</div>
</li>
<li>
<p>Install the Snort  prerequisites</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo apt install -y gcc libpcre3-dev zlib1g-dev libluajit-5.1-dev libpcap-dev openssl libssl-dev libnghttp2-dev libdumbnet-dev bison flex libdnet</code></pre>
</div>
</div>
</li>
<li>
<p>Install daq</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">cd ~/snort_src
wget https://www.snort.org/downloads/snort/daq-2.0.6.tar.gz
tar -xvzf daq-2.0.6.tar.gz
cd daq-2.0.6
./configure &amp;&amp; make &amp;&amp; sudo make install</code></pre>
</div>
</div>
</li>
<li>
<p>Install Snort</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">cd ~/snort_src
wget https://www.snort.org/downloads/snort/snort-2.9.15.1.tar.gz
tar -xvzf snort-2.9.15.1.tar.gz
cd snort-2.9.15.1
./configure --enable-sourcefire &amp;&amp; make &amp;&amp; sudo make install</code></pre>
</div>
</div>
</li>
<li>
<p>Update the shared libraries</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo ldconfig</code></pre>
</div>
</div>
</li>
<li>
<p>Create a symbolic link to snort</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo ln -s /usr/local/bin/snort /usr/sbin/snort</code></pre>
</div>
</div>
</li>
<li>
<p>Create the folder structure and create the required files</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo mkdir -p /etc/snort/rules
sudo mkdir /etc/snort/preproc_rules
sudo mkdir /var/log/snort
sudo mkdir /usr/local/lib/snort_dynamicrules

sudo touch /etc/snort/rules/white_list.rules
sudo touch /etc/snort/rules/black_list.rules
sudo touch /etc/snort/rules/local.rules</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the configuration files from the download folder</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo cp ~/snort_src/snort-2.9.15.1/etc/*.conf* /etc/snort
sudo cp ~/snort_src/snort-2.9.15.1/etc/*.map /etc/snort
sudo cp ~/snort_src/snort-2.9.15.1/etc/*.dtd /etc/snort</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Verify that Snort can run</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo snort -V</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/snort2.9_installed.png" alt="Snort installed">
</div>
<div class="title">Figure 11. Snort installed</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_download_rules">Download rules</h5>
<div class="paragraph">
<p>For the malware lab we will use PRO rules from emergingthreats.net. If
you don&#8217;t have a pro version, there are also free rules available <a href="https://rules.emergingthreats.net/OPEN_download_instructions.html">here</a> or from
the Snort community.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download and setup the rules:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">cd ~/snort_src/
wget https://rules.emergingthreatspro.com/$oinkcode/snort-2.9.15.1/etpro.rules.tar.gz
sudo tar -xvf etpro.rules.tar.gz -C /etc/snort</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_edit_snort_configuration_file">Edit Snort configuration file</h5>
<div class="paragraph">
<p>We will want to modify our Snort configuration file to enable some extra features and
so that we don’t have to specify settings at the command line.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open the configuration file</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo nano /etc/snort/snort.conf</code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Find these sections shown below in the configuration file and change the parameters to reflect the examples here.</p>
<div class="listingblock">
<div class="content">
<pre># Setup the network addresses you are protecting
ipvar HOME_NET 172.16.2.0/24</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre># Set up the external network addresses. Leave as "any" in most situations
ipvar EXTERNAL_NET !$HOME_NET</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre># Path to your rules files (this can be a relative path)
var RULE_PATH /etc/snort/rules
var SO_RULE_PATH /etc/snort/so_rules
var PREPROC_RULE_PATH /etc/snort/preproc_rules</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre># Set the absolute path appropriately
var WHITE_LIST_PATH /etc/snort/rules
var BLACK_LIST_PATH /etc/snort/rules</pre>
</div>
</div>
</li>
<li>
<p>Scroll down to section 6 (line 519) and set the output for unified2 to log under filename
of snort.log:</p>
<div class="listingblock">
<div class="content">
<pre># unified2
# Recommended for most installs
output unified2: filename snort.log, limit 128
output alert_fast: alert.fast</pre>
</div>
</div>
</li>
<li>
<p>Lastly, scroll down to the bottom of the file to find the list of included rules.
Replaces this list with the following (in our case).</p>
<div class="listingblock">
<div class="content">
<pre>include $RULE_PATH/local.rules

include activex.rules
include attack_response.rules
include botcc.portgrouped.rules
include botcc.rules
include chat.rules
include ciarmy.rules
include compromised.rules
include current_events.rules
include deleted.rules
include dns.rules
include dos.rules
include drop.rules
include dshield.rules
include exploit.rules
include ftp.rules
include games.rules
include icmp_info.rules
include icmp.rules
include imap.rules
include inappropriate.rules
include info.rules
include local.rules
include malware.rules
include misc.rules
include mobile_malware.rules
include netbios.rules
include p2p.rules
include policy.rules
include pop3.rules
include rpc.rules
include scada.rules
include scada_special.rules
include scan.rules
include shellcode.rules
include smtp.rules
include snmp.rules
include sql.rules
include telnet.rules
include tftp.rules
include tor.rules
include trojan.rules
include user_agents.rules
include voip.rules
include web_client.rules
include web_server.rules
include web_specific_apps.rules
include worm.rules</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Test if snort loads the configuration file correctly::</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">snort -T -c /etc/snort/snort.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result must be <code>Snort successfully validated the configuration!</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/snort2.9_configcomplete.png" alt="Snort with configuration">
</div>
<div class="title">Figure 12. Snort with configuration</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Make a snapshot!
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_configuring_network_cards">Configuring Network Cards</h5>
<div class="paragraph">
<p>Snort has sometimes problems with network card where GRO or / and LRO is enabled,
in this section we will disable these features of the network card.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, check which MAC-address correspondent with which Ethernet Adapter, run:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">ifconfig -a</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/snort_ifconfig.png" alt="NIDS ifconfig">
</div>
<div class="title">Figure 13. NIDS ifconfig</div>
</div>
<div class="paragraph">
<p>In our case ens33 is the IPS1 (Vmnet2) and ens34 the IPS2 (VMnet3) network,
we will now use IPS1 for the capture.</p>
</div>
</li>
<li>
<p>For a NIDS we want to disable offloading (GRO and LRO) on the network card.
To check if it is enabled:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo ethtool -k ens33 | grep receive-offload</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nids_offloadstatus.png" alt="NIDS Offload status">
</div>
<div class="title">Figure 14. NIDS Offload status</div>
</div>
</li>
<li>
<p>As you can see the GRO is enabled, we could disable it with the ethtool,
but the setting would not persist after a system reboot. The solution is to
create a systemD script to set this every boot.</p>
<div class="paragraph">
<p>Create the sytemD script</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo nano /lib/systemd/system/ethtool.service</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enter the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[Unit]
Description=Ethtool Configration for Network Interface

[Service]
Requires=network.target
Type=oneshot
ExecStart=/sbin/ethtool -K ens33 gro off
ExecStart=/sbin/ethtool -K ens33 lro off

[Install]
WantedBy=multi-user.target</pre>
</div>
</div>
<div class="paragraph">
<p>Once the file is created, enable the service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo systemctl enable ethtool
sudo service ethtool start</code></pre>
</div>
</div>
</li>
<li>
<p>Check if both are disabled</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo ethtool -k ens33 | grep receive-offload</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nids_offloadstatus_off.png" alt="NIDS Offload status off">
</div>
<div class="title">Figure 15. NIDS Offload status off</div>
</div>
<div class="paragraph">
<p>Both are disabled now.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_run_a_test">Run a test</h5>
<div class="paragraph">
<p>To test if Snort is processing as intended the traffic made by the Victim machine,
we add a custom detection rule alert on incoming ICMP connections.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open local.rules</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo nano /etc/snort/rules/local.rules</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the following line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>alert icmp any any -&gt; $HOME_NET any (msg:"ICMP test"; sid:10000001; rev:001;)</pre>
</div>
</div>
</li>
<li>
<p>Start snort with:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo snort -A console -i ens33  -c /etc/snort/snort.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Start the Victim machine</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Open PowerShll and run the command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">ping www.google.com</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On the NIDS side you should see these alerts:</p>
<div class="imageblock">
<div class="content">
<img src="images/snort_imcp_alert.png" alt="Snort IMCP alert">
</div>
<div class="title">Figure 16. Snort IMCP alert</div>
</div>
<div class="paragraph">
<p>It is working!</p>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Make a snapshot!
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_suricata_5_0">2.4.3. Suricata 5.0</h4>
<div class="paragraph">
<p>The second NIDS software we will install is Suricata (<a href="https://suricata-ids.org/" class="bare">https://suricata-ids.org/</a>). For the
main we follow <a href="https://hackertarget.com/install-suricata-ubuntu-5-minutes/">this</a> guide.
The steps are documented below</p>
</div>
<div class="sect4">
<h5 id="_installation_3">Installation</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log into the NIDS VM</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Login from the host machine with SHH to the NIDS VM for easy copy and paste
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Execute these commands:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Make a folder to store the downloaded files</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">mkdir ~/suricata_src
cd ~/suricata_src</code></pre>
</div>
</div>
</li>
<li>
<p>Install Suricata (5.0.2)</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo add-apt-repository ppa:oisf/suricata-stable
sudo apt update
sudo apt install suricata</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Verify that Suricata can run</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo suricata -V</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/suricata5.0.2_installed.png" alt="Suricata installed">
</div>
<div class="title">Figure 17. Suricata installed</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Make a snapshot!
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_download_rules_2">Download rules</h5>
<div class="paragraph">
<p>For the malware lab we will use PRO rules from emergingthreats.net. If
you don&#8217;t have a pro version, there are also free rules available <a href="https://rules.emergingthreats.net/OPEN_download_instructions.html">here</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download and setup the rules:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">cd ~/suricata_src/
wget https://rules.emergingthreatspro.com/$oinkcode/suricata-5.0/etpro.rules.tar.gz
sudo rm -r /etc/suricata/rules
sudo tar -xvf etpro.rules.tar.gz -C /etc/suricata</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_edit_suricata_configuration_file">Edit Suricata configuration file</h5>
<div class="paragraph">
<p>We have to modify the configuration files to enable the rules and some other things.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open the configuration file</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">cd /etc/suricata
sudo nano suricata.yaml</code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Find these sections shown below in the configuration file and change the parameters to reflect the examples here.</p>
<div class="listingblock">
<div class="content">
<pre>HOME_NET: "[172.16.2.0/24]"</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>  - eve.log:
      [...]
      - stats:
          totals: no
          threads: no
          deltas: no</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>default-rule-path: /etc/suricata/rules

rule-files:
- local.rules
- activex.rules
- adware_pup.rules
- attack_response.rules
- botcc.portgrouped.rules
- botcc.rules
- chat.rules
- ciarmy.rules
- coinminer.rules
- compromised.rules
- current_events.rules
- deleted.rules
- dns.rules
- dos.rules
- drop.rules
- dshield.rules
- exploit_kit.rules
- exploit.rules
- ftp.rules
- games.rules
- hunting.rules
- icmp_info.rules
- icmp.rules
- imap.rules
- inappropriate.rules
- info.rules
- ja3.rules
- malware.rules
- misc.rules
- mobile_malware.rules
- netbios.rules
- p2p.rules
- phishing.rules
- policy.rules
- pop3.rules
- rpc.rules
- scada.rules
- scada_special.rules
- scan.rules
- shellcode.rules
- smtp.rules
- snmp.rules
- sql.rules
- telnet.rules
- tftp.rules
- tor.rules
- user_agents.rules
- voip.rules
- web_client.rules
- web_server.rules
- web_specific_apps.rules
- worm.rules</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Test if Suricata loads the configuration file correctly:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo suricata -T -c /etc/suricata/suricata.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/suricata_config_loaded.png" alt="Suricata configuration loaded">
</div>
<div class="title">Figure 18. Suricata configuration loaded</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_run_a_test_2">Run a test</h5>
<div class="paragraph">
<p>To test if Suricata is processing as intended the traffic made by the Victim machine,
we add a custom detection rule alert on incoming ICMP connections.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open local.rules</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo nano /etc/suricata/rules/local.rules</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the following line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>alert icmp any any -&gt; $HOME_NET any (msg:"ICMP test"; sid:10000001; rev:001;)</pre>
</div>
</div>
</li>
<li>
<p>Start Suricata with:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo suricata -i ens33  -c /etc/suricata/suricata.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Open a new windows and run this command in the NIDS:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo tail -f /var/log/suricata/fast.log</code></pre>
</div>
</div>
</li>
<li>
<p>Start the Victim machine</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Open PowerShll and run the command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">ping www.google.com</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On the NIDS side you should see these alert:</p>
<div class="imageblock">
<div class="content">
<img src="images/suricata_imcp_alert.png" alt="Suricata IMCP alert">
</div>
<div class="title">Figure 19. Suricata IMCP alert</div>
</div>
<div class="paragraph">
<p>It is working!</p>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Make a snapshot!
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hids">2.5. HIDS</h3>
<div class="paragraph">
<p>We will use Ubuntu Server as operating system for the NIDS and HIDS VM.
The ISO can be downloaded <a href="https://ubuntu.com/download/server">here</a> (18.04.4).</p>
</div>
<div class="sect3">
<h4 id="_installation_ubuntu_server_18_2">2.5.1. Installation Ubuntu Server 18</h4>
<div class="paragraph">
<p>This installation is quite similar tot the NIDS installation.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In VMware Workstation Pro click on File &gt; New Virtual Machine</p>
</li>
<li>
<p>Select Typical &gt; Next</p>
</li>
<li>
<p>Browse to the downloaded Ubuntu Server ISO &gt; Next</p>
</li>
<li>
<p>Fill in the fields name, username (we use hids), password</p>
</li>
<li>
<p>Give the VM a name, enter 'NIDS' &gt; Next</p>
</li>
<li>
<p>Set the maximum disk size to 80 GB</p>
</li>
<li>
<p>Select 'Store virtual disk size as a single file' &gt; next</p>
</li>
<li>
<p>Click 'Customize hardware'</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Set the amount of memory to 4096 MB</p>
</li>
<li>
<p>Set number of processors to 2</p>
</li>
<li>
<p>Set number of cores per processor to 2</p>
</li>
<li>
<p>Click on 'Network Adapter'</p>
<div class="ulist">
<ul>
<li>
<p>Select 'Connect at power on'</p>
</li>
<li>
<p>Select Custom &gt; VMnet1 (Host-only)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Select 'USB controller' &gt; Click 'Remove'</p>
</li>
<li>
<p>Select 'Sound Card' &gt; Click 'Remove'</p>
</li>
<li>
<p>Select 'Printer' &gt; Click 'Remove'</p>
</li>
<li>
<p>Press Close</p>
</li>
</ol>
</div>
</li>
<li>
<p>Press Finish</p>
</li>
<li>
<p>Open the VM settings again</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Remove the CD/ DVD with the 'autoinst.iso' inserted</p>
</li>
<li>
<p>Remove the Floppy drive with the 'autoinst.flp' inserted</p>
</li>
</ol>
</div>
</li>
<li>
<p>Start the Virtual Machine<br></p>
</li>
<li>
<p>Go through the installation process</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>At the software selection phase, make sure to install OpenSSH server'</p>
</li>
</ol>
</div>
</li>
<li>
<p>Shut down the VM after the installation is completed</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Remove the last CD/DVD drive</p>
</li>
<li>
<p>Document the MAC-address of the network adapter</p>
</li>
</ol>
</div>
</li>
<li>
<p>Log in to the pfSense web UI</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to Services &gt; DHCP server and select 'LAN'</p>
</li>
<li>
<p>Add a Static mapping</p>
<div class="ulist">
<ul>
<li>
<p>Mac-adress of the NIDS machine (00:0C:29:87:0A:4C)</p>
</li>
<li>
<p>IP Address: 172.16.1.3</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click 'save' &gt; 'Apply changes'</p>
</li>
</ol>
</div>
</li>
<li>
<p>Start up the VM</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Log in</p>
</li>
<li>
<p>Verify that the IP-adress is 172.16.1.3 (with ifconfig)</p>
</li>
<li>
<p>Update the vm with:</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>sudo apt-get update; sudo apt-get upgrade;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_docker_io">2.5.2. Docker.io</h4>
<div class="paragraph">
<p>We will use Docker to run the Wazuh server and ELK stack. We have to install
docker first.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log into the HIDS VM</p>
</li>
<li>
<p>Install docker</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">curl -sSL https://get.docker.com/ | sh</code></pre>
</div>
</div>
</li>
<li>
<p>Start and automate Docker</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo systemctl enable docker
sudo systemctl start docker</code></pre>
</div>
</div>
</li>
<li>
<p>Check if docker is installed correctly</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">docker --version</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>Docker version 19.03.8, build afacb8b7f0</pre>
</div>
</div>
</li>
<li>
<p>Install docker-compose</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.25.4/docker-compose-Linux-x86_64&quot; -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose</code></pre>
</div>
</div>
</li>
<li>
<p>Check if docker-compose is installed correctly</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">docker-compose --version</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>docker-compose version 1.25.4, build 8d51620a</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_wazuh_container">2.5.3. Wazuh Container</h4>
<div class="paragraph">
<p>We will follow <a href="https://documentation.wazuh.com/3.11/docker/wazuh-container.html">this</a> guide
to deploy the Wazuh container, steps are documented below.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Increase max_map_count:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo nano /etc/sysctl.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>At the bottom add this line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>vm.max_map_count=262144</pre>
</div>
</div>
</li>
<li>
<p>Get the docker-compose-yml</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">curl -so docker-compose.yml https://raw.githubusercontent.com/wazuh/wazuh-docker/v3.11.4_7.6.1/docker-compose.yml</code></pre>
</div>
</div>
</li>
<li>
<p>Get the Wazuh repository</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">git clone https://github.com/wazuh/wazuh-docker.git -b v3.11.4_7.6.1 --single-branch</code></pre>
</div>
</div>
</li>
<li>
<p>Start the stack</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo docker-compose up</code></pre>
</div>
</div>
<div class="paragraph">
<p>The installation will take some time. When the installation is done go
to <a href="https://https://172.16.1.3/" class="bare">https://https://172.16.1.3/</a> in your browser (host machine), default password
is 'foo' and 'bar'. You should have access now to the Kibana interface.</p>
</div>
</li>
<li>
<p>We want the docker container to start automatically at system start up. Follow the
steps below.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Stop the stack (Ctrl-c)</p>
</li>
<li>
<p>Open docker-compose-app.service (New file)</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo nano /etc/systemd/system/docker-compose-app.service</code></pre>
</div>
</div>
<div class="paragraph">
<p>And add the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[Unit]
Description=Docker Compose Application Service
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/home/hids/
ExecStart=/usr/local/bin/docker-compose up -d
ExecStop=/usr/local/bin/docker-compose down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target</pre>
</div>
</div>
</li>
<li>
<p>Enable and start the service</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo systemctl enable docker-compose-app
sudo systemctl start docker-compose-app</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_last_configuration">3. Last configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_pfsense_firewall_rules">3.1. pfSense Firewall rules</h3>
<div class="paragraph">
<p>We will add some extra firewall rules to prevent the Victim accessing other machines
in the network (except of de Wazuh server).</p>
</div>
<div class="sect3">
<h4 id="_wan_interface">3.1.1. WAN interface</h4>
<div class="paragraph">
<p>We don&#8217;t need any extra rules for the WAN interface.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pfsense_wan_rules.png" alt="pfSense WAN rules">
</div>
<div class="title">Figure 20. pfSense WAN rules</div>
</div>
</div>
<div class="sect3">
<h4 id="_lan_interface">3.1.2. LAN interface</h4>
<div class="paragraph">
<p>We want to block all traffic to local networks (the RFC1918 alias we created).
However the host machine (172.16.1.2) needs SSH access tot the victim and the HIDS
will use the Wazuh Ports 1514 and 1515 to communicate with the victim and retrieve the alerts.</p>
</div>
<div class="paragraph">
<p>If we keep this in mind the configuration should look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pfsense_lan_rules.png" alt="pfSense LAN rules">
</div>
<div class="title">Figure 21. pfSense LAN rules</div>
</div>
</div>
<div class="sect3">
<h4 id="_opt1_interface">3.1.3. OPT1 interface</h4>
<div class="paragraph">
<p>As with the LAN interface we want to block all traffic to local networks (the RFC1918 alias we created),
except for the communication to the HIDS Wazuh server. The Victim machine is allowed to have access to the
outside world.</p>
</div>
<div class="paragraph">
<p>The configuration should look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pfsense_lan_rules.png" alt="pfSense OPT1 rules">
</div>
<div class="title">Figure 22. pfSense OPT1 rules</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_register_wazuh_agent_at_wazuh_manager">3.2. Register Wazuh agent at Wazuh manager</h3>
<div class="paragraph">
<p>The installation of both the Victim VM and the HIDS VM is completed, it is time
to register the Wazuh agent at the Wazuh Manger.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start the HIDS and run the command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">docker-compose exec wazuh /bin/bash</code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add add the agent with manage_agents:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">/var/ossec/bin/manage_agents -a any -n windows-10</code></pre>
</div>
</div>
</li>
<li>
<p>List the agents</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">/var/ossec/bin/manage_agents -l</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>Available agents:
   ID: 004, Name: windows-10, IP: any</pre>
</div>
</div>
</li>
<li>
<p>Use the ID from the previous command to extract the agents key using:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">/var/ossec/bin/manage_agents -e 004</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>Agent key information for '004' is:
MDA0IHdpbmRvd3MtMTAgYW55IDA3YzI3OTNjYjA3NDJiODAwYjE4ZWEwY2FlZTk1NGU2MGIwODNiOTFmMjcyMGFhMWVjZDg5ZGMwMGU5NDIxMWQ=</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Open a shell at the Victim machine</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Import the previous key with manage_agents</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">'C:\Program Files (x86)\ossec-agent\manage_agents' -i MDA0IHdpbmRvd3MtMTAgYW55IDA3YzI3OTNjYjA3NDJiODAwYjE4ZWEwY2FlZTk1NGU2MGIwODNiOTFmMjcyMGFhMWVjZDg5ZGMwMGU5NDIxMWQ=</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/agent_addmanager.png" alt="Wazuh Agent key imported">
</div>
<div class="title">Figure 23. Wazuh Agent key imported</div>
</div>
</li>
<li>
<p>Restart wazuh-manager (Victim machine)</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">Restart-Service -Name wazuh</code></pre>
</div>
</div>
<div class="paragraph">
<p>At the HIDS Kibana interface, the agent should be visible now:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/wazuh_agent_kibana.png" alt="Wazuh Agent registered Kibana">
</div>
<div class="title">Figure 24. Wazuh Agent registered Kibana </div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_install_filebeat_on_nids">3.3. Install Filebeat on NIDS</h3>
<div class="paragraph">
<p>Wazuh uses an Elasticsearch database with Kibana to display the alerts. It
is possible to send the NIDS alerts to the same Elasticsearch database to
centralize the alerts.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a shell at the NIDS</p>
</li>
<li>
<p>Install Filebeat</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.6.1-amd64.deb
sudo dpkg -i filebeat-7.6.1-amd64.deb
rm filebeat-7.6.1-amd64.deb</code></pre>
</div>
</div>
</li>
<li>
<p>Open the configuration file</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo nano /etc/filebeat/filebeat.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Find the input section and fill in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>- type: log
  enabled: true
  paths:
    - /var/log/snort/alert.fast
    - /var/log/suricata/fast.log</pre>
</div>
</div>
<div class="paragraph">
<p>Find the output section and fill in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>output.elasticsearch:
  # Array of hosts to connect to.
  hosts: ["172.16.1.2:9200"]

  #api_key: "id:api_key"
  username: "foo"
  password: "bar"</pre>
</div>
</div>
</li>
<li>
<p>Enable the Suricata module</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo filebeat modules enable suricata
filebeat setup -e</code></pre>
</div>
</div>
</li>
<li>
<p>Enable and start filebeat</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo systemctl enable filebeat
sudo sytemctl start filebeat</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_wazuh">3.4. Wazuh</h3>
<div class="sect3">
<h4 id="_configure_wazuh_group_configuration">3.4.1. Configure Wazuh Group configuration</h4>
<div class="paragraph">
<p>We will edit some Wazuh Monitor configuration. All time intervals must
be less than 5 minutes because each malware test will last no longer than 10 minutes.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open the Kibana web interface and navigate to the Wazuh App &gt; Management&gt; Groups</p>
</li>
<li>
<p>Press the + to create a new group</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Set the group name to 'Windows10-Machines'</p>
</li>
</ol>
</div>
</li>
<li>
<p>Click 'Edit configuration'</p>
<div class="paragraph">
<p>Paste the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;!-- Log analysis --&gt;
  &lt;localfile&gt;
    &lt;location&gt;Application&lt;/location&gt;
    &lt;log_format&gt;eventchannel&lt;/log_format&gt;
  &lt;/localfile&gt;

  &lt;localfile&gt;
    &lt;location&gt;Security&lt;/location&gt;
    &lt;log_format&gt;eventchannel&lt;/log_format&gt;
    &lt;query&gt;Event/System[EventID != 5145 and EventID != 5156 and EventID != 5447 and
      EventID != 4656 and EventID != 4658 and EventID != 4663 and EventID != 4660 and
      EventID != 4670 and EventID != 4690 and EventID != 4703 and EventID != 4907 and
      EventID != 5152 and EventID != 5157]&lt;/query&gt;
  &lt;/localfile&gt;

  &lt;localfile&gt;
    &lt;location&gt;System&lt;/location&gt;
    &lt;log_format&gt;eventchannel&lt;/log_format&gt;
  &lt;/localfile&gt;

  &lt;localfile&gt;
    &lt;location&gt;active-response\active-responses.log&lt;/location&gt;
    &lt;log_format&gt;syslog&lt;/log_format&gt;
  &lt;/localfile&gt;

  &lt;!-- Sysmon tool --&gt;
  &lt;localfile&gt;
  &lt;location&gt;Microsoft-Windows-Sysmon/Operational&lt;/location&gt;
  &lt;log_format&gt;eventchannel&lt;/log_format&gt;
  &lt;/localfile&gt;

  &lt;!-- Policy monitoring --&gt;
  &lt;rootcheck&gt;
		&lt;disabled&gt;no&lt;/disabled&gt;
		&lt;base_directory&gt;C:&lt;/base_directory&gt;
		&lt;scanall&gt;yes&lt;/scanall&gt;
		&lt;skip_nfs&gt;no&lt;/skip_nfs&gt;
		&lt;frequency&gt;60&lt;/frequency&gt;
		&lt;check_dev&gt;yes&lt;/check_dev&gt;
		&lt;check_files&gt;no&lt;/check_files&gt;
		&lt;check_if&gt;yes&lt;/check_if&gt;
		&lt;check_pids&gt;yes&lt;/check_pids&gt;
		&lt;check_ports&gt;yes&lt;/check_ports&gt;
		&lt;check_sys&gt;yes&lt;/check_sys&gt;
		&lt;check_trojans&gt;no&lt;/check_trojans&gt;
		&lt;check_winaudit&gt;no&lt;/check_winaudit&gt;
		&lt;check_winmalware&gt;yes&lt;/check_winmalware&gt;
		&lt;check_winapps&gt;yes&lt;/check_winapps&gt;
		&lt;windows_apps&gt;./shared/win_applications_rcl.txt&lt;/windows_apps&gt;
		&lt;windows_malware&gt;./shared/win_malware_rcl.txt&lt;/windows_malware&gt;
	&lt;/rootcheck&gt;

  &lt;!-- Security Configuration Assessment --&gt;
  &lt;sca&gt;
    &lt;enabled&gt;yes&lt;/enabled&gt;
    &lt;scan_on_start&gt;yes&lt;/scan_on_start&gt;
    &lt;interval&gt;4m&lt;/interval&gt;
    &lt;skip_nfs&gt;yes&lt;/skip_nfs&gt;
  &lt;/sca&gt;

  &lt;!-- File integrity monitoring --&gt;
  &lt;syscheck&gt;

    &lt;disabled&gt;no&lt;/disabled&gt;

    &lt;!-- Frequency that syscheck is executed default every 12 hours --&gt;
    &lt;frequency&gt;60&lt;/frequency&gt;

    &lt;!-- Default files to be monitored. --&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\regedit.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\system.ini&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\win.ini&lt;/directories&gt;

    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\at.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\attrib.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\cacls.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\cmd.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\drivers\etc&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\eventcreate.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\ftp.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\lsass.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\net.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\net1.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\netsh.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\reg.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\regedt32.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\regsvr32.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\runas.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\sc.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\schtasks.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\sethc.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\subst.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\wbem\WMIC.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\WindowsPowerShell\v1.0\powershell.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\SysNative\winrm.vbs&lt;/directories&gt;

    &lt;!-- 32-bit programs. --&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\at.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\attrib.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\cacls.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\cmd.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\drivers\etc&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\eventcreate.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\ftp.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\net.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\net1.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\netsh.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\reg.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\regedit.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\regedt32.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\regsvr32.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\runas.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\sc.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\schtasks.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\sethc.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\subst.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\wbem\WMIC.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\WindowsPowerShell\v1.0\powershell.exe&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes"&gt;%WINDIR%\System32\winrm.vbs&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" whodata="yes" report_changes="yes"&gt;%PROGRAMDATA%\Microsoft\Windows\Start Menu\Programs\Startup&lt;/directories&gt;
    &lt;directories check_all="yes" realtime="yes" report_changes="yes" whodata="yes"&gt;C:\Users\John Williams\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup&lt;/directories&gt;
    &lt;ignore&gt;%PROGRAMDATA%\Microsoft\Windows\Start Menu\Programs\Startup\desktop.ini&lt;/ignore&gt;
    &lt;ignore&gt;C:\Users\John Williams\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\desktop.ini&lt;/ignore&gt;
    &lt;ignore type="sregex"&gt;.log$|.htm$|.jpg$|.png$|.chm$|.pnf$|.evtx$&lt;/ignore&gt;

    &lt;!-- Windows registry entries to monitor. --&gt;
    &lt;windows_registry&gt;HKEY_LOCAL_MACHINE\Software\Classes\batfile&lt;/windows_registry&gt;
    &lt;windows_registry&gt;HKEY_LOCAL_MACHINE\Software\Classes\cmdfile&lt;/windows_registry&gt;
    &lt;windows_registry&gt;HKEY_LOCAL_MACHINE\Software\Classes\comfile&lt;/windows_registry&gt;
    &lt;windows_registry&gt;HKEY_LOCAL_MACHINE\Software\Classes\exefile&lt;/windows_registry&gt;
    &lt;windows_registry&gt;HKEY_LOCAL_MACHINE\Software\Classes\piffile&lt;/windows_registry&gt;
    &lt;windows_registry&gt;HKEY_LOCAL_MACHINE\Software\Classes\AllFilesystemObjects&lt;/windows_registry&gt;
    &lt;windows_registry&gt;HKEY_LOCAL_MACHINE\Software\Classes\Directory&lt;/windows_registry&gt;
    &lt;windows_registry&gt;HKEY_LOCAL_MACHINE\Software\Classes\Folder&lt;/windows_registry&gt;
    &lt;windows_registry arch="both"&gt;HKEY_LOCAL_MACHINE\Software\Classes\Protocols&lt;/windows_registry&gt;
    &lt;windows_registry arch="both"&gt;HKEY_LOCAL_MACHINE\Software\Policies&lt;/windows_registry&gt;
    &lt;windows_registry&gt;HKEY_LOCAL_MACHINE\Security&lt;/windows_registry&gt;
    &lt;windows_registry arch="both"&gt;HKEY_LOCAL_MACHINE\Software\Microsoft\Internet Explorer&lt;/windows_registry&gt;

    &lt;windows_registry&gt;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services&lt;/windows_registry&gt;
    &lt;windows_registry&gt;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\KnownDLLs&lt;/windows_registry&gt;
    &lt;windows_registry&gt;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurePipeServers\winreg&lt;/windows_registry&gt;

    &lt;windows_registry arch="both"&gt;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run&lt;/windows_registry&gt;
    &lt;windows_registry arch="both"&gt;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce&lt;/windows_registry&gt;
    &lt;windows_registry&gt;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnceEx&lt;/windows_registry&gt;
    &lt;windows_registry arch="both"&gt;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\URL&lt;/windows_registry&gt;
    &lt;windows_registry arch="both"&gt;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies&lt;/windows_registry&gt;
    &lt;windows_registry arch="both"&gt;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Windows&lt;/windows_registry&gt;
    &lt;windows_registry arch="both"&gt;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon&lt;/windows_registry&gt;

    &lt;windows_registry arch="both"&gt;HKEY_LOCAL_MACHINE\Software\Microsoft\Active Setup\Installed Components&lt;/windows_registry&gt;

	&lt;!-- added manualy --&gt;
	&lt;windows_registry arch="both"&gt;HKEY_USERS\S-1-5-21-438079597-2123118846-2669748851-1001\Software\Microsoft\Windows\CurrentVersion\Run&lt;/windows_registry&gt;
	&lt;windows_registry arch="both"&gt;HKEY_USERS\S-1-5-21-438079597-2123118846-2669748851-1001\Software\Microsoft\Windows\CurrentVersion\RunOnce&lt;/windows_registry&gt;

    &lt;!-- Windows registry entries to ignore. --&gt;
    &lt;registry_ignore&gt;HKEY_LOCAL_MACHINE\Security\Policy\Secrets&lt;/registry_ignore&gt;
    &lt;registry_ignore&gt;HKEY_LOCAL_MACHINE\Security\SAM\Domains\Account\Users&lt;/registry_ignore&gt;
    &lt;registry_ignore type="sregex"&gt;\Enum$&lt;/registry_ignore&gt;
    &lt;registry_ignore&gt;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\MpsSvc\Parameters\AppCs&lt;/registry_ignore&gt;
    &lt;registry_ignore&gt;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\MpsSvc\Parameters\PortKeywords\DHCP&lt;/registry_ignore&gt;
    &lt;registry_ignore&gt;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\MpsSvc\Parameters\PortKeywords\IPTLSIn&lt;/registry_ignore&gt;
    &lt;registry_ignore&gt;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\MpsSvc\Parameters\PortKeywords\IPTLSOut&lt;/registry_ignore&gt;
    &lt;registry_ignore&gt;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\MpsSvc\Parameters\PortKeywords\RPC-EPMap&lt;/registry_ignore&gt;
    &lt;registry_ignore&gt;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\MpsSvc\Parameters\PortKeywords\Teredo&lt;/registry_ignore&gt;
    &lt;registry_ignore&gt;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\PolicyAgent\Parameters\Cache&lt;/registry_ignore&gt;
    &lt;registry_ignore&gt;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnceEx&lt;/registry_ignore&gt;
    &lt;registry_ignore&gt;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\ADOVMPPackage\Final&lt;/registry_ignore&gt;

    &lt;!-- Frequency for ACL checking (seconds) --&gt;
    &lt;windows_audit_interval&gt;240&lt;/windows_audit_interval&gt;
  &lt;/syscheck&gt;

  &lt;!-- System inventory --&gt;
  &lt;wodle name="syscollector"&gt;
    &lt;disabled&gt;no&lt;/disabled&gt;
    &lt;interval&gt;4m&lt;/interval&gt;
    &lt;scan_on_start&gt;yes&lt;/scan_on_start&gt;
    &lt;hardware&gt;yes&lt;/hardware&gt;
    &lt;os&gt;yes&lt;/os&gt;
    &lt;network&gt;yes&lt;/network&gt;
    &lt;packages&gt;yes&lt;/packages&gt;
    &lt;ports all="yes"&gt;yes&lt;/ports&gt;
    &lt;processes&gt;yes&lt;/processes&gt;
  &lt;/wodle&gt;

  &lt;!-- Active response --&gt;
  &lt;active-response&gt;
    &lt;disabled&gt;no&lt;/disabled&gt;
    &lt;ca_store&gt;wpk_root.pem&lt;/ca_store&gt;
    &lt;ca_verification&gt;yes&lt;/ca_verification&gt;
  &lt;/active-response&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Summary changes made from default configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sysmon tool:</p>
<div class="listingblock">
<div class="content">
<pre>&lt;!-- Sysmon tool --&gt;
&lt;localfile&gt;
&lt;location&gt;Microsoft-Windows-Sysmon/Operational&lt;/location&gt;
&lt;log_format&gt;eventchannel&lt;/log_format&gt;
&lt;/localfile&gt;</pre>
</div>
</div>
</li>
<li>
<p>Rootcheck:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Frequency: 60</p>
</li>
</ol>
</div>
</li>
<li>
<p>Security Configuration Assessment (SCA):</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>interval: 4m</p>
</li>
</ol>
</div>
</li>
<li>
<p>Syscheck:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Frequency: 60 seconds</p>
</li>
<li>
<p>For all directories: realtime="yes" whodata="yes"</p>
</li>
<li>
<p>For <code>%PROGRAMDATA%\Microsoft\Windows\Start Menu\Programs\Startup&lt;/directories&gt;</code>: report_changes="yes"</p>
</li>
<li>
<p>Added directory to monitor: <code>C:\Users\John Williams\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</code></p>
</li>
<li>
<p>Added 2 Windows registry entries to monitor:</p>
<div class="listingblock">
<div class="content">
<pre>&lt;!-- added manualy --&gt;
&lt;windows_registry arch="both"&gt;HKEY_USERS\S-1-5-21-438079597-2123118846-2669748851-1001\Software\Microsoft\Windows\CurrentVersion\Run&lt;/windows_registry&gt;
&lt;windows_registry arch="both"&gt;HKEY_USERS\S-1-5-21-438079597-2123118846-2669748851-1001\Software\Microsoft\Windows\CurrentVersion\RunOnce&lt;/windows_registry&gt;</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>System inventory (wodle name="syscollector")</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Interval: 4m</p>
</li>
<li>
<p>Ports all: yes</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_sysmon_second_batch">3.4.2. Sysmon Second Batch</h4>
<div class="paragraph">
<p>In the first batch of the malware research (10 samples) Wazuh did not detect any
malware but only some indicators. That is why we will install a ruleset using Sysmon to enhance
the detection capabilities. We will use the ruleset from <a href="https://github.com/Hestat/ossec-sysmon">Hetstat</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start the victim machine</p>
</li>
<li>
<p>Download the System tool and unzip it:<br>
<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon" class="bare">https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon</a></p>
</li>
<li>
<p>Download the following configuration (the .xml file) and move it to the uzipped System tool folder<br>
<a href="https://github.com/SwiftOnSecurity/sysmon-config" class="bare">https://github.com/SwiftOnSecurity/sysmon-config</a></p>
</li>
<li>
<p>Open PowerShell as administrator and navigate to the unzipped folder</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Install Sysmon with the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">.\Sysmon64.exe -accepteula -i sysmonconfig-export.xml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Make sure the following lines are added to  the Wazuh Group Configuration:</p>
<div class="listingblock">
<div class="content">
<pre>&lt;localfile&gt;
&lt;location&gt;Microsoft-Windows-Sysmon/Operational&lt;/location&gt;
&lt;log_format&gt;eventchannel&lt;/log_format&gt;
&lt;/localfile&gt;</pre>
</div>
</div>
</li>
<li>
<p>Open the kibana web interface</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to Wazuh &gt; Management &gt; Ruleset</p>
</li>
<li>
<p>Click 'Manage rules files' and open 'local_rules.xml'</p>
</li>
<li>
<p>Add the following line at the bottom:</p>
<div class="listingblock">
<div class="content">
<pre>&lt;!-- https://raw.githubusercontent.com/Hestat/ossec-sysmon/master/local_rules.xml --&gt;</pre>
</div>
</div>
</li>
<li>
<p>Paste content from <a href="https://raw.githubusercontent.com/Hestat/ossec-sysmon/master/local_rules.xml" class="bare">https://raw.githubusercontent.com/Hestat/ossec-sysmon/master/local_rules.xml</a> underneath</p>
</li>
<li>
<p>Click Save and restart now</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_sysmon_third_batch">3.4.3. Sysmon Third Batch</h4>
<div class="paragraph">
<p>Contrary to expectations, the results of batch 2 were (almost) no better than batch 1.
But we analyzed the Sysmon events generated after the execution and the corresponding rules.
We founded several critical bugs why no alerts were generated. The first option was to correct these rules and test them again.
But we decided we need a more elaborate version of Sysmon rules, so we started writing a script to generate OSSEC / Wazuh rules from Sigma rules (<a href="https://github.com/Neo23x0/sigma" class="bare">https://github.com/Neo23x0/sigma</a>).
The result is that we have written all Windows Sigma rules to the OSSEC format, both the rules and the script are available
<a href="https://github.com/SanWieb/sigWah">here</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start the victim machine</p>
</li>
<li>
<p>Download the sysmonconfig.xml from <a href="https://github.com/SanWieb/sigWah">sigWah</a>:<br></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Install the configuration with the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">.\Sysmon64.exe -i sysmonconfig.xml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Make sure the following lines are added to  the Wazuh Group Configuration:</p>
<div class="listingblock">
<div class="content">
<pre>&lt;localfile&gt;
&lt;location&gt;Microsoft-Windows-Sysmon/Operational&lt;/location&gt;
&lt;log_format&gt;eventchannel&lt;/log_format&gt;
&lt;/localfile&gt;</pre>
</div>
</div>
</li>
<li>
<p>Open the kibana web interface</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to Wazuh &gt; Management &gt; Ruleset</p>
</li>
<li>
<p>Click 'Manage rules files' and open 'local_rules.xml'</p>
</li>
<li>
<p>Remove the old Sysmon rules and add the following line at the bottom:</p>
<div class="listingblock">
<div class="content">
<pre>&lt;!-- https://github.com/SanWieb/sigWah --&gt;</pre>
</div>
</div>
</li>
<li>
<p>Paste content from <a href="https://github.com/SanWieb/sigWah/master/local_rules.xml" class="bare">https://github.com/SanWieb/sigWah/master/local_rules.xml</a> underneath</p>
</li>
<li>
<p>Click Save and restart now</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tor_vpn_tunneling">3.5. Tor / VPN Tunneling</h3>
<div class="paragraph">
<p>To prevent to give away your own IP-address to the malware developers it is
possible to configure a Tor Network at the pfSense VM or a VPN. <a href="https://turbofuture.com/computers/How-to-Set-Up-a-Tor-Proxy-Server-on-pfSense">Here</a>
are the steps described to install a Tor-network and <a href="https://protonvpn.com/support/pfsense-vpn-setup/">here</a> to configure a Free VPN (ProtonVPN) . Alternatively you could use a Mobile phone / Raspberry Pi to setup a network
with 3/4G.</p>
</div>
<div class="paragraph">
<p>We will use the last option because we have a unlimited data abonnement available.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cuckoo_sandbox">4. Cuckoo Sandbox</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Follow <a href="https://gist.github.com/braimee/bf570a62f53f71bad1906c6e072ce993">this guide</a> to setup
the Cuckoo Sandbox environment.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-06-07 13:19:03 +0200
</div>
</div>
</body>
</html>